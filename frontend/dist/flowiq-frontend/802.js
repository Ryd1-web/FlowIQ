"use strict";(self.webpackChunkflowiq_frontend=self.webpackChunkflowiq_frontend||[]).push([[802],{5802:(X,h,o)=>{o.r(h),o.d(h,{AiInsightsModule:()=>N});var c=o(177),d=o(9417),g=o(5312),b=o(7468),f=o(6354),O=o(3904),e=o(4438),R=o(1626),P=o(6230),u=o(5596),C=o(6471),v=o(9213),x=o(9183),l=o(2102),k=o(9631),I=o(8834);function E(n,s){1&n&&(e.j41(0,"div",3),e.nrm(1,"mat-spinner"),e.k0s())}function j(n,s){if(1&n&&(e.j41(0,"mat-card",13)(1,"div",14)(2,"div",15)(3,"mat-icon"),e.EFF(4,"psychology"),e.k0s()(),e.j41(5,"span",16),e.EFF(6,"Recommendation"),e.k0s(),e.j41(7,"mat-chip",17),e.EFF(8),e.k0s()(),e.j41(9,"div",18),e.EFF(10),e.k0s(),e.j41(11,"div",19)(12,"mat-icon"),e.EFF(13,"analytics"),e.k0s(),e.EFF(14),e.nI1(15,"percent"),e.k0s()()),2&n){const t=s.$implicit,i=e.XpG(2);e.R7$(7),e.Y8G("ngClass",i.getRiskClass(t.riskLevel)),e.R7$(),e.SpI(" ",t.riskLevel," Risk "),e.R7$(2),e.JRh(t.recommendation),e.R7$(4),e.SpI(" Confidence Score: ",e.i5U(15,4,t.confidence,"1.0-0")," ")}}function A(n,s){if(1&n&&(e.j41(0,"div",20)(1,"mat-chip",21),e.EFF(2),e.k0s(),e.j41(3,"span"),e.EFF(4),e.nI1(5,"percent"),e.k0s()()),2&n){const t=e.XpG(2);e.R7$(2),e.JRh(t.receiptCategory),e.R7$(2),e.SpI("Confidence: ",e.i5U(5,2,t.receiptConfidence||0,"1.0-0"),"")}}function T(n,s){if(1&n&&(e.j41(0,"div",22)(1,"mat-icon"),e.EFF(2,"error"),e.k0s(),e.j41(3,"span"),e.EFF(4),e.k0s()()),2&n){const t=e.XpG(2);e.R7$(4),e.JRh(t.receiptError)}}function S(n,s){if(1&n){const t=e.RV6();e.j41(0,"div")(1,"section",4)(2,"h1"),e.EFF(3,"AI Insights"),e.k0s(),e.j41(4,"p"),e.EFF(5,"Prediction and anomaly recommendations powered by the AI service."),e.k0s()(),e.j41(6,"section",5),e.DNE(7,j,16,7,"mat-card",6),e.k0s(),e.j41(8,"mat-card",7)(9,"h2"),e.EFF(10,"Receipt Categorization"),e.k0s(),e.j41(11,"p"),e.EFF(12,"Paste receipt text to auto-categorize it with AI."),e.k0s(),e.j41(13,"mat-form-field",8)(14,"mat-label"),e.EFF(15,"Receipt Text"),e.k0s(),e.j41(16,"textarea",9),e.mxI("ngModelChange",function(r){e.eBV(t);const a=e.XpG();return e.DH7(a.receiptText,r)||(a.receiptText=r),e.Njj(r)}),e.k0s()(),e.j41(17,"button",10),e.bIt("click",function(){e.eBV(t);const r=e.XpG();return e.Njj(r.categorizeReceipt())}),e.EFF(18," Categorize "),e.k0s(),e.DNE(19,A,6,5,"div",11)(20,T,5,1,"div",12),e.k0s()()}if(2&n){const t=e.XpG();e.R7$(7),e.Y8G("ngForOf",t.insights),e.R7$(9),e.R50("ngModel",t.receiptText),e.R7$(),e.Y8G("disabled",t.categorizing),e.R7$(2),e.Y8G("ngIf",t.receiptCategory),e.R7$(),e.Y8G("ngIf",t.receiptError)}}function $(n,s){if(1&n&&(e.j41(0,"div",23)(1,"mat-icon"),e.EFF(2,"error"),e.k0s(),e.EFF(3),e.k0s()),2&n){const t=e.XpG();e.R7$(3),e.SpI(" ",t.error,"\n")}}let z=(()=>{class n{http;businessService;insights=[];loading=!0;error="";businessId="";receiptText="";categorizing=!1;receiptCategory="";receiptConfidence=null;receiptError="";constructor(t,i){this.http=t,this.businessService=i}ngOnInit(){this.businessService.getAllForCurrentUser().subscribe({next:t=>{if(!t.length||!t[0].id)return this.error="No business found for this user.",void(this.loading=!1);this.businessId=t[0].id,this.getInsights(this.businessId).subscribe({next:i=>{this.insights=i,this.loading=!1},error:i=>{this.error=i?.message||"Failed to load AI insights.",this.loading=!1}})},error:()=>{this.error="Failed to load businesses.",this.loading=!1}})}getInsights(t){return(0,b.p)({prediction:this.http.get(`${g.c.apiBaseUrl}/ai/predict/${t}?lookbackDays=60&predictionDays=30`),anomaly:this.http.get(`${g.c.apiBaseUrl}/ai/anomaly/${t}?lookbackDays=60`)}).pipe((0,f.T)(({prediction:i,anomaly:r})=>{const a=this.unwrapOrThrow(i,"AI prediction service unavailable."),p=this.unwrapOrThrow(r,"AI anomaly service unavailable.");return this.toInsights(a,p)}))}categorizeReceipt(){this.receiptText.trim()?(this.categorizing=!0,this.receiptError="",this.receiptCategory="",this.receiptConfidence=null,this.http.post(`${g.c.apiBaseUrl}/ai/categorize/receipt`,{receiptText:this.receiptText}).pipe((0,f.T)(t=>this.unwrapOrThrow(t,"AI receipt categorization service unavailable."))).subscribe({next:t=>{this.categorizing=!1,this.receiptCategory=t.category??t.Category??"Other",this.receiptConfidence=Number(t.confidenceScore??t.ConfidenceScore??0)},error:t=>{this.categorizing=!1,this.receiptError=t?.message||"Failed to categorize receipt."}})):this.receiptError="Please enter receipt text."}getRiskClass(t){return"High"===t?"risk-high":"Medium"===t?"risk-medium":"risk-low"}toInsights(t,i){const r=t.recommendation??t.Recommendation??"No prediction recommendation.",a=Number(t.confidenceScore??t.ConfidenceScore??0),p=(t.predictedStatus??t.PredictedStatus??"Warning").toLowerCase(),F=i.anomalies??i.Anomalies??[],y=Number(i.totalAnomalies??i.TotalAnomalies??F.length),D=i.recommendation??i.Recommendation??"No anomaly recommendation.",Y=Number(i.confidenceScore??i.ConfidenceScore??.75),U=p.includes("healthy")?"Low":p.includes("critical")?"High":"Medium";let m="Low";return y>2||F.some(M=>"high"===(M.severity??M.Severity??"").toLowerCase())?m="High":y>0&&(m="Medium"),[{recommendation:r,confidence:a,riskLevel:U},{recommendation:D,confidence:Y,riskLevel:m}]}unwrapOrThrow(t,i){const r=t;if(r&&"object"==typeof r&&"success"in r){if(!r.success||null==r.data)throw new Error(r.message||i);return r.data}return(0,O.s)(t,{})}static \u0275fac=function(i){return new(i||n)(e.rXU(R.Qq),e.rXU(P.u))};static \u0275cmp=e.VBU({type:n,selectors:[["app-ai-insights"]],decls:3,vars:3,consts:[["class","ai-loading",4,"ngIf"],[4,"ngIf"],["class","ai-error",4,"ngIf"],[1,"ai-loading"],[1,"insights-header"],[1,"insights-grid"],["class","ai-card",4,"ngFor","ngForOf"],[1,"receipt-card"],["appearance","outline",1,"receipt-field"],["matInput","","rows","4",3,"ngModelChange","ngModel"],["mat-raised-button","","color","primary","type","button",3,"click","disabled"],["class","receipt-result",4,"ngIf"],["class","receipt-error",4,"ngIf"],[1,"ai-card"],[1,"ai-header"],[1,"icon-wrap"],[1,"ai-title"],[1,"risk-chip",3,"ngClass"],[1,"ai-recommendation"],[1,"ai-confidence"],[1,"receipt-result"],[1,"risk-chip","risk-low"],[1,"receipt-error"],[1,"ai-error"]],template:function(i,r){1&i&&e.DNE(0,E,2,0,"div",0)(1,S,21,5,"div",1)(2,$,4,1,"div",2),2&i&&(e.Y8G("ngIf",r.loading),e.R7$(),e.Y8G("ngIf",!r.loading&&!r.error),e.R7$(),e.Y8G("ngIf",r.error))},dependencies:[c.YU,c.Sq,c.bT,d.me,d.BC,d.vS,u.RN,C.Jl,v.An,x.LG,l.rl,l.nJ,k.fg,I.$z,c.m1],styles:[".insights-header[_ngcontent-%COMP%]{margin-bottom:24px}.insights-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-family:var(--font-heading);font-size:24px;color:var(--text-primary)}.insights-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:4px 0 0;color:var(--text-muted)}.insights-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}.ai-card[_ngcontent-%COMP%]{padding:20px;background:var(--surface);border-radius:16px;border:1px solid var(--border-soft)}.ai-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:12px}.icon-wrap[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:#14b8a61f;color:#0f766e}.ai-title[_ngcontent-%COMP%]{font-weight:600;font-size:16px;flex:1;color:var(--text-primary)}.risk-chip[_ngcontent-%COMP%]{font-size:12px}.risk-chip.risk-low[_ngcontent-%COMP%]{background:#0f766e24;color:#0f766e}body.dark-theme[_nghost-%COMP%]   .risk-chip.risk-low[_ngcontent-%COMP%], body.dark-theme   [_nghost-%COMP%]   .risk-chip.risk-low[_ngcontent-%COMP%]{background:#22c55e40;color:#22c55e}.risk-chip.risk-medium[_ngcontent-%COMP%]{background:#d9770624;color:#b45309}.risk-chip.risk-high[_ngcontent-%COMP%]{background:#dc262624;color:#b91c1c}.ai-recommendation[_ngcontent-%COMP%]{font-size:15px;margin-bottom:12px;color:var(--text-primary)}.ai-confidence[_ngcontent-%COMP%]{color:#0f766e;display:flex;align-items:center;gap:8px;font-size:13px}.ai-loading[_ngcontent-%COMP%], .ai-error[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:300px;font-size:16px;color:var(--text-muted)}.receipt-card[_ngcontent-%COMP%]{margin-top:16px;padding:20px;border-radius:16px;border:1px solid var(--border-soft);background:var(--surface)}.receipt-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 6px;font-family:var(--font-heading);color:var(--text-primary)}.receipt-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 12px;color:var(--text-muted)}.receipt-field[_ngcontent-%COMP%]{width:100%}.receipt-result[_ngcontent-%COMP%]{margin-top:12px;display:flex;align-items:center;gap:8px;color:var(--text-primary)}.receipt-error[_ngcontent-%COMP%]{margin-top:12px;display:flex;align-items:center;gap:6px;color:#dc2626}@media (max-width: 900px){.insights-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}"]})}return n})();var G=o(8498);const w=[{path:"",component:z}];let N=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275mod=e.$C({type:n});static \u0275inj=e.G2t({imports:[c.MD,d.YN,u.Hu,C.YN,v.m_,x.D6,l.RG,k.fS,I.Hl,G.iI.forChild(w)]})}return n})()}}]);