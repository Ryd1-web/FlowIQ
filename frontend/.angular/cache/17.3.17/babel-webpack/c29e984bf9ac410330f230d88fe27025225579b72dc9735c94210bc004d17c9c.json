{"ast":null,"code":"import { environment } from '../../../environments/environment';\nimport { forkJoin } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { unwrapApiData } from '../../core/models/api-response.model';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"../../core/services/business.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/material/card\";\nimport * as i5 from \"@angular/material/chips\";\nimport * as i6 from \"@angular/material/icon\";\nimport * as i7 from \"@angular/material/progress-spinner\";\nfunction AiInsightsComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 3);\n    i0.ɵɵelement(1, \"mat-spinner\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction AiInsightsComponent_div_1_mat_card_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"mat-card\", 7)(1, \"div\", 8)(2, \"div\", 9)(3, \"mat-icon\");\n    i0.ɵɵtext(4, \"psychology\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"span\", 10);\n    i0.ɵɵtext(6, \"Recommendation\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"mat-chip\", 11);\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(9, \"div\", 12);\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"div\", 13)(12, \"mat-icon\");\n    i0.ɵɵtext(13, \"analytics\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(14);\n    i0.ɵɵpipe(15, \"percent\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const insight_r1 = ctx.$implicit;\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngClass\", ctx_r1.getRiskClass(insight_r1.riskLevel));\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", insight_r1.riskLevel, \" Risk \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(insight_r1.recommendation);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" Confidence Score: \", i0.ɵɵpipeBind2(15, 4, insight_r1.confidence, \"1.0-0\"), \" \");\n  }\n}\nfunction AiInsightsComponent_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"section\", 4)(2, \"h1\");\n    i0.ɵɵtext(3, \"AI Insights\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"p\");\n    i0.ɵɵtext(5, \"Actionable recommendations with confidence and risk context.\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(6, \"section\", 5);\n    i0.ɵɵtemplate(7, AiInsightsComponent_div_1_mat_card_7_Template, 16, 7, \"mat-card\", 6);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r1.insights);\n  }\n}\nfunction AiInsightsComponent_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 14)(1, \"mat-icon\");\n    i0.ɵɵtext(2, \"error\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.error, \"\\n\");\n  }\n}\nexport let AiInsightsComponent = /*#__PURE__*/(() => {\n  class AiInsightsComponent {\n    http;\n    businessService;\n    insights = [];\n    loading = true;\n    error = '';\n    constructor(http, businessService) {\n      this.http = http;\n      this.businessService = businessService;\n    }\n    ngOnInit() {\n      this.businessService.getAllForCurrentUser().subscribe({\n        next: businesses => {\n          if (!businesses.length || !businesses[0].id) {\n            this.error = 'No business found for this user.';\n            this.loading = false;\n            return;\n          }\n          const businessId = businesses[0].id;\n          this.getInsights(businessId).subscribe({\n            next: insights => {\n              this.insights = insights;\n              this.loading = false;\n            },\n            error: () => {\n              this.error = 'Failed to load AI insights.';\n              this.loading = false;\n            }\n          });\n        },\n        error: () => {\n          this.error = 'Failed to load businesses.';\n          this.loading = false;\n        }\n      });\n    }\n    getInsights(businessId) {\n      return forkJoin({\n        prediction: this.http.get(`${environment.apiBaseUrl}/ai/predict/${businessId}?lookbackDays=60&predictionDays=30`),\n        anomaly: this.http.get(`${environment.apiBaseUrl}/ai/anomaly/${businessId}?lookbackDays=60`)\n      }).pipe(map(({\n        prediction,\n        anomaly\n      }) => this.toInsights(prediction, anomaly)));\n    }\n    getRiskClass(riskLevel) {\n      if (riskLevel === 'High') {\n        return 'risk-high';\n      }\n      if (riskLevel === 'Medium') {\n        return 'risk-medium';\n      }\n      return 'risk-low';\n    }\n    toInsights(predictionResponse, anomalyResponse) {\n      const prediction = unwrapApiData(predictionResponse, {});\n      const anomaly = unwrapApiData(anomalyResponse, {});\n      const predictionPoints = prediction.predictions ?? prediction.Predictions ?? [];\n      const anomalies = anomaly.anomalies ?? anomaly.Anomalies ?? [];\n      const avgPredictedNet = predictionPoints.length > 0 ? predictionPoints.reduce((sum, point) => sum + Number(point.predictedNet ?? point.PredictedNet ?? 0), 0) / predictionPoints.length : 0;\n      const predictionConfidence = Number(prediction.confidenceScore ?? prediction.ConfidenceScore ?? 0);\n      const anomalyConfidence = Number(anomaly.confidenceScore ?? anomaly.ConfidenceScore ?? 0);\n      const insights = [{\n        recommendation: avgPredictedNet >= 0 ? 'Projected net cashflow for the next cycle is positive. Maintain current income momentum and monitor variable expenses.' : 'Projected net cashflow for the next cycle is negative. Reduce discretionary spend and improve receivables collection.',\n        confidence: predictionConfidence,\n        riskLevel: avgPredictedNet >= 0 ? 'Low' : 'High'\n      }];\n      if (anomalies.length > 0) {\n        const topAnomaly = anomalies[0];\n        const anomalyDate = topAnomaly.date ?? topAnomaly.Date ?? '';\n        const anomalyType = topAnomaly.type ?? topAnomaly.Type ?? 'Transaction';\n        const anomalyAmount = Number(topAnomaly.amount ?? topAnomaly.Amount ?? 0).toLocaleString();\n        insights.push({\n          recommendation: `${anomalyType} anomaly detected on ${new Date(anomalyDate).toLocaleDateString()}. Amount: INR ${anomalyAmount}. Review and verify this transaction pattern.`,\n          confidence: anomalyConfidence,\n          riskLevel: anomalies.length > 2 ? 'High' : 'Medium'\n        });\n      } else {\n        insights.push({\n          recommendation: 'No significant anomalies were detected in the recent transaction history.',\n          confidence: anomalyConfidence || 0.7,\n          riskLevel: 'Low'\n        });\n      }\n      return insights;\n    }\n    static ɵfac = function AiInsightsComponent_Factory(t) {\n      return new (t || AiInsightsComponent)(i0.ɵɵdirectiveInject(i1.HttpClient), i0.ɵɵdirectiveInject(i2.BusinessService));\n    };\n    static ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: AiInsightsComponent,\n      selectors: [[\"app-ai-insights\"]],\n      decls: 3,\n      vars: 3,\n      consts: [[\"class\", \"ai-loading\", 4, \"ngIf\"], [4, \"ngIf\"], [\"class\", \"ai-error\", 4, \"ngIf\"], [1, \"ai-loading\"], [1, \"insights-header\"], [1, \"insights-grid\"], [\"class\", \"ai-card\", 4, \"ngFor\", \"ngForOf\"], [1, \"ai-card\"], [1, \"ai-header\"], [1, \"icon-wrap\"], [1, \"ai-title\"], [1, \"risk-chip\", 3, \"ngClass\"], [1, \"ai-recommendation\"], [1, \"ai-confidence\"], [1, \"ai-error\"]],\n      template: function AiInsightsComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵtemplate(0, AiInsightsComponent_div_0_Template, 2, 0, \"div\", 0)(1, AiInsightsComponent_div_1_Template, 8, 1, \"div\", 1)(2, AiInsightsComponent_div_2_Template, 4, 1, \"div\", 2);\n        }\n        if (rf & 2) {\n          i0.ɵɵproperty(\"ngIf\", ctx.loading);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", !ctx.loading && !ctx.error);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.error);\n        }\n      },\n      dependencies: [i3.NgClass, i3.NgForOf, i3.NgIf, i4.MatCard, i5.MatChip, i6.MatIcon, i7.MatProgressSpinner, i3.PercentPipe],\n      styles: [\".insights-header[_ngcontent-%COMP%]{margin-bottom:24px}.insights-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-family:var(--font-heading);font-size:24px;color:#0f172a}.insights-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:4px 0 0;color:#64748b}.insights-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}.ai-card[_ngcontent-%COMP%]{padding:20px;background:#fff;border-radius:16px;border:1px solid var(--border-soft)}.ai-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:12px}.icon-wrap[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:#14b8a61f;color:#0f766e}.ai-title[_ngcontent-%COMP%]{font-weight:600;font-size:16px;flex:1;color:#0f172a}.risk-chip[_ngcontent-%COMP%]{font-size:12px}.risk-chip.risk-low[_ngcontent-%COMP%]{background:#0f766e24;color:#0f766e}.risk-chip.risk-medium[_ngcontent-%COMP%]{background:#d9770624;color:#b45309}.risk-chip.risk-high[_ngcontent-%COMP%]{background:#dc262624;color:#b91c1c}.ai-recommendation[_ngcontent-%COMP%]{font-size:15px;margin-bottom:12px;color:#334155}.ai-confidence[_ngcontent-%COMP%]{color:#0f766e;display:flex;align-items:center;gap:8px;font-size:13px}.ai-loading[_ngcontent-%COMP%], .ai-error[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:300px;font-size:16px;color:#64748b}@media (max-width: 900px){.insights-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}\"]\n    });\n  }\n  return AiInsightsComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}