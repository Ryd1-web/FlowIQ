{"ast":null,"code":"import { environment } from '../../../environments/environment';\nimport { forkJoin } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { unwrapApiData } from '../../core/models/api-response.model';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"../../core/services/business.service\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nimport * as i5 from \"@angular/material/card\";\nimport * as i6 from \"@angular/material/chips\";\nimport * as i7 from \"@angular/material/icon\";\nimport * as i8 from \"@angular/material/progress-spinner\";\nimport * as i9 from \"@angular/material/form-field\";\nimport * as i10 from \"@angular/material/input\";\nimport * as i11 from \"@angular/material/button\";\nfunction AiInsightsComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 3);\n    i0.ɵɵelement(1, \"mat-spinner\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction AiInsightsComponent_div_1_mat_card_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"mat-card\", 13)(1, \"div\", 14)(2, \"div\", 15)(3, \"mat-icon\");\n    i0.ɵɵtext(4, \"psychology\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"span\", 16);\n    i0.ɵɵtext(6, \"Recommendation\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"mat-chip\", 17);\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(9, \"div\", 18);\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"div\", 19)(12, \"mat-icon\");\n    i0.ɵɵtext(13, \"analytics\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(14);\n    i0.ɵɵpipe(15, \"percent\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const insight_r2 = ctx.$implicit;\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngClass\", ctx_r2.getRiskClass(insight_r2.riskLevel));\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", insight_r2.riskLevel, \" Risk \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(insight_r2.recommendation);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" Confidence Score: \", i0.ɵɵpipeBind2(15, 4, insight_r2.confidence, \"1.0-0\"), \" \");\n  }\n}\nfunction AiInsightsComponent_div_1_div_19_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 20)(1, \"mat-chip\", 21);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"span\");\n    i0.ɵɵtext(4);\n    i0.ɵɵpipe(5, \"percent\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.receiptCategory);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\"Confidence: \", i0.ɵɵpipeBind2(5, 2, ctx_r2.receiptConfidence || 0, \"1.0-0\"), \"\");\n  }\n}\nfunction AiInsightsComponent_div_1_div_20_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22)(1, \"mat-icon\");\n    i0.ɵɵtext(2, \"error\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"span\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r2.receiptError);\n  }\n}\nfunction AiInsightsComponent_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\")(1, \"section\", 4)(2, \"h1\");\n    i0.ɵɵtext(3, \"AI Insights\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"p\");\n    i0.ɵɵtext(5, \"Prediction and anomaly recommendations powered by the AI service.\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(6, \"section\", 5);\n    i0.ɵɵtemplate(7, AiInsightsComponent_div_1_mat_card_7_Template, 16, 7, \"mat-card\", 6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"mat-card\", 7)(9, \"h2\");\n    i0.ɵɵtext(10, \"Receipt Categorization\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"p\");\n    i0.ɵɵtext(12, \"Paste receipt text to auto-categorize it with AI.\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"mat-form-field\", 8)(14, \"mat-label\");\n    i0.ɵɵtext(15, \"Receipt Text\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(16, \"textarea\", 9);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function AiInsightsComponent_div_1_Template_textarea_ngModelChange_16_listener($event) {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r2 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r2.receiptText, $event) || (ctx_r2.receiptText = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(17, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function AiInsightsComponent_div_1_Template_button_click_17_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.categorizeReceipt());\n    });\n    i0.ɵɵtext(18, \" Categorize \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(19, AiInsightsComponent_div_1_div_19_Template, 6, 5, \"div\", 11)(20, AiInsightsComponent_div_1_div_20_Template, 5, 1, \"div\", 12);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r2.insights);\n    i0.ɵɵadvance(9);\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.receiptText);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"disabled\", ctx_r2.categorizing);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.receiptCategory);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.receiptError);\n  }\n}\nfunction AiInsightsComponent_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 23)(1, \"mat-icon\");\n    i0.ɵɵtext(2, \"error\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.error, \"\\n\");\n  }\n}\nexport let AiInsightsComponent = /*#__PURE__*/(() => {\n  class AiInsightsComponent {\n    http;\n    businessService;\n    insights = [];\n    loading = true;\n    error = '';\n    businessId = '';\n    receiptText = '';\n    categorizing = false;\n    receiptCategory = '';\n    receiptConfidence = null;\n    receiptError = '';\n    constructor(http, businessService) {\n      this.http = http;\n      this.businessService = businessService;\n    }\n    ngOnInit() {\n      this.businessService.getAllForCurrentUser().subscribe({\n        next: businesses => {\n          if (!businesses.length || !businesses[0].id) {\n            this.error = 'No business found for this user.';\n            this.loading = false;\n            return;\n          }\n          this.businessId = businesses[0].id;\n          this.getInsights(this.businessId).subscribe({\n            next: insights => {\n              this.insights = insights;\n              this.loading = false;\n            },\n            error: err => {\n              this.error = err?.message || 'Failed to load AI insights.';\n              this.loading = false;\n            }\n          });\n        },\n        error: () => {\n          this.error = 'Failed to load businesses.';\n          this.loading = false;\n        }\n      });\n    }\n    getInsights(businessId) {\n      return forkJoin({\n        prediction: this.http.get(`${environment.apiBaseUrl}/ai/predict/${businessId}?lookbackDays=60&predictionDays=30`),\n        anomaly: this.http.get(`${environment.apiBaseUrl}/ai/anomaly/${businessId}?lookbackDays=60`)\n      }).pipe(map(({\n        prediction,\n        anomaly\n      }) => {\n        const predictionData = this.unwrapOrThrow(prediction, 'AI prediction service unavailable.');\n        const anomalyData = this.unwrapOrThrow(anomaly, 'AI anomaly service unavailable.');\n        return this.toInsights(predictionData, anomalyData);\n      }));\n    }\n    categorizeReceipt() {\n      if (!this.receiptText.trim()) {\n        this.receiptError = 'Please enter receipt text.';\n        return;\n      }\n      this.categorizing = true;\n      this.receiptError = '';\n      this.receiptCategory = '';\n      this.receiptConfidence = null;\n      this.http.post(`${environment.apiBaseUrl}/ai/categorize/receipt`, {\n        receiptText: this.receiptText\n      }).pipe(map(res => this.unwrapOrThrow(res, 'AI receipt categorization service unavailable.'))).subscribe({\n        next: res => {\n          this.categorizing = false;\n          this.receiptCategory = res.category ?? res.Category ?? 'Other';\n          this.receiptConfidence = Number(res.confidenceScore ?? res.ConfidenceScore ?? 0);\n        },\n        error: err => {\n          this.categorizing = false;\n          this.receiptError = err?.message || 'Failed to categorize receipt.';\n        }\n      });\n    }\n    getRiskClass(riskLevel) {\n      if (riskLevel === 'High') {\n        return 'risk-high';\n      }\n      if (riskLevel === 'Medium') {\n        return 'risk-medium';\n      }\n      return 'risk-low';\n    }\n    toInsights(prediction, anomaly) {\n      const predictionRecommendation = prediction.recommendation ?? prediction.Recommendation ?? 'No prediction recommendation.';\n      const predictionConfidence = Number(prediction.confidenceScore ?? prediction.ConfidenceScore ?? 0);\n      const predictedStatus = (prediction.predictedStatus ?? prediction.PredictedStatus ?? 'Warning').toLowerCase();\n      const anomalies = anomaly.anomalies ?? anomaly.Anomalies ?? [];\n      const totalAnomalies = Number(anomaly.totalAnomalies ?? anomaly.TotalAnomalies ?? anomalies.length);\n      const anomalyRecommendation = anomaly.recommendation ?? anomaly.Recommendation ?? 'No anomaly recommendation.';\n      const anomalyConfidence = Number(anomaly.confidenceScore ?? anomaly.ConfidenceScore ?? 0.75);\n      const predictionRisk = predictedStatus.includes('healthy') ? 'Low' : predictedStatus.includes('critical') ? 'High' : 'Medium';\n      let anomalyRisk = 'Low';\n      if (totalAnomalies > 2 || anomalies.some(a => (a.severity ?? a.Severity ?? '').toLowerCase() === 'high')) {\n        anomalyRisk = 'High';\n      } else if (totalAnomalies > 0) {\n        anomalyRisk = 'Medium';\n      }\n      return [{\n        recommendation: predictionRecommendation,\n        confidence: predictionConfidence,\n        riskLevel: predictionRisk\n      }, {\n        recommendation: anomalyRecommendation,\n        confidence: anomalyConfidence,\n        riskLevel: anomalyRisk\n      }];\n    }\n    unwrapOrThrow(response, unavailableMessage) {\n      const apiResponse = response;\n      if (apiResponse && typeof apiResponse === 'object' && 'success' in apiResponse) {\n        if (!apiResponse.success || apiResponse.data === null || apiResponse.data === undefined) {\n          throw new Error(apiResponse.message || unavailableMessage);\n        }\n        return apiResponse.data;\n      }\n      return unwrapApiData(response, {});\n    }\n    static ɵfac = function AiInsightsComponent_Factory(t) {\n      return new (t || AiInsightsComponent)(i0.ɵɵdirectiveInject(i1.HttpClient), i0.ɵɵdirectiveInject(i2.BusinessService));\n    };\n    static ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: AiInsightsComponent,\n      selectors: [[\"app-ai-insights\"]],\n      decls: 3,\n      vars: 3,\n      consts: [[\"class\", \"ai-loading\", 4, \"ngIf\"], [4, \"ngIf\"], [\"class\", \"ai-error\", 4, \"ngIf\"], [1, \"ai-loading\"], [1, \"insights-header\"], [1, \"insights-grid\"], [\"class\", \"ai-card\", 4, \"ngFor\", \"ngForOf\"], [1, \"receipt-card\"], [\"appearance\", \"outline\", 1, \"receipt-field\"], [\"matInput\", \"\", \"rows\", \"4\", 3, \"ngModelChange\", \"ngModel\"], [\"mat-raised-button\", \"\", \"color\", \"primary\", \"type\", \"button\", 3, \"click\", \"disabled\"], [\"class\", \"receipt-result\", 4, \"ngIf\"], [\"class\", \"receipt-error\", 4, \"ngIf\"], [1, \"ai-card\"], [1, \"ai-header\"], [1, \"icon-wrap\"], [1, \"ai-title\"], [1, \"risk-chip\", 3, \"ngClass\"], [1, \"ai-recommendation\"], [1, \"ai-confidence\"], [1, \"receipt-result\"], [1, \"risk-chip\", \"risk-low\"], [1, \"receipt-error\"], [1, \"ai-error\"]],\n      template: function AiInsightsComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵtemplate(0, AiInsightsComponent_div_0_Template, 2, 0, \"div\", 0)(1, AiInsightsComponent_div_1_Template, 21, 5, \"div\", 1)(2, AiInsightsComponent_div_2_Template, 4, 1, \"div\", 2);\n        }\n        if (rf & 2) {\n          i0.ɵɵproperty(\"ngIf\", ctx.loading);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", !ctx.loading && !ctx.error);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.error);\n        }\n      },\n      dependencies: [i3.NgClass, i3.NgForOf, i3.NgIf, i4.DefaultValueAccessor, i4.NgControlStatus, i4.NgModel, i5.MatCard, i6.MatChip, i7.MatIcon, i8.MatProgressSpinner, i9.MatFormField, i9.MatLabel, i10.MatInput, i11.MatButton, i3.PercentPipe],\n      styles: [\".insights-header[_ngcontent-%COMP%]{margin-bottom:24px}.insights-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-family:var(--font-heading);font-size:24px;color:var(--text-primary)}.insights-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:4px 0 0;color:var(--text-muted)}.insights-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}.ai-card[_ngcontent-%COMP%]{padding:20px;background:var(--surface);border-radius:16px;border:1px solid var(--border-soft)}.ai-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:12px}.icon-wrap[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:#14b8a61f;color:#0f766e}.ai-title[_ngcontent-%COMP%]{font-weight:600;font-size:16px;flex:1;color:var(--text-primary)}.risk-chip[_ngcontent-%COMP%]{font-size:12px}.risk-chip.risk-low[_ngcontent-%COMP%]{background:#0f766e24;color:#0f766e}body.dark-theme[_nghost-%COMP%]   .risk-chip.risk-low[_ngcontent-%COMP%], body.dark-theme   [_nghost-%COMP%]   .risk-chip.risk-low[_ngcontent-%COMP%]{background:#22c55e40;color:#22c55e}.risk-chip.risk-medium[_ngcontent-%COMP%]{background:#d9770624;color:#b45309}.risk-chip.risk-high[_ngcontent-%COMP%]{background:#dc262624;color:#b91c1c}.ai-recommendation[_ngcontent-%COMP%]{font-size:15px;margin-bottom:12px;color:var(--text-primary)}.ai-confidence[_ngcontent-%COMP%]{color:#0f766e;display:flex;align-items:center;gap:8px;font-size:13px}.ai-loading[_ngcontent-%COMP%], .ai-error[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:300px;font-size:16px;color:var(--text-muted)}.receipt-card[_ngcontent-%COMP%]{margin-top:16px;padding:20px;border-radius:16px;border:1px solid var(--border-soft);background:var(--surface)}.receipt-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 6px;font-family:var(--font-heading);color:var(--text-primary)}.receipt-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 12px;color:var(--text-muted)}.receipt-field[_ngcontent-%COMP%]{width:100%}.receipt-result[_ngcontent-%COMP%]{margin-top:12px;display:flex;align-items:center;gap:8px;color:var(--text-primary)}.receipt-error[_ngcontent-%COMP%]{margin-top:12px;display:flex;align-items:center;gap:6px;color:#dc2626}@media (max-width: 900px){.insights-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}\"]\n    });\n  }\n  return AiInsightsComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}